# 网络基础

>本文部分图片内容的资源来自[方糖全栈课](https://quanzhanke.github.io/)

### 网络传输假想示意图

![发照片要处理的问题](https://ws1.sinaimg.cn/large/40dfde6fgy1fqexjx2ulvj20pi0gan0i.jpg)

图片很清晰的描述了我们网络传输的过程,我们要传输数据,首先要知道往哪传,这就需要知道目标地址(`寻址和路由`),当我们知道地址后,需要有一条明确的传输通路(`数据链路`),如果我们传输的时候数据包过大,我们要考虑将这个包拆成合适的大小(`分片`),如果真的要拆分,我们还要考虑到将拆分的数据做上对应的标记(`序列码`),这些准备工作都做好了,我们就可以将这些数据装入运输工具中(`封装`),如果在传输过程中通路拥堵,我们还要做一些对应的预案(`拥塞控制`)

这其实是一个假想中的网络传输过程,它和网络传输数据的过程非常类似,借助生活中的例子,会让我们对这个过程印象加深

### OSI七层模型 和 TCP/IP协议簇

![](https://ws1.sinaimg.cn/large/40dfde6fgy1fqexpc9cylj20oi0fz0wa.jpg)

>OSI七层模型 和 TCP/IP协议簇的结构图

#### OSI和七层模型

开放系统互连参考模型 (Open System Interconnect 简称OSI）是国际标准化组织(ISO)和国际电报电话咨询委员会(CCITT)联合制定的开放系统互连参考模型，为开放式互连信息系统提供了一种功能结构的框架。它从低到高分别是：物理层、数据链路层、网络层、传输层、会话层、表示层和应用层。

OSI的模型每一层是独立的,通常把1-4层协议称作下层协议,5-7层称作上层协议

![](http://img.blog.csdn.net/20160731161720376)

OSI引入了服务,接口,协议,分层的概念,OSI是先有模型,后有协议,先有标准,后在标准的基础上进行网络实现

OSI的七层模型,每一层都有对应的相关协议,我们从高到低依次举例

在**应用层**,最常见的是超文本传输协议(`HTTP`),文件传输协议(`FTP`),域名系统(`DNS`),用户数据报文协议(`UDP`)等

在**表示层**,有轻量级表示协议(`LPP`),会话服务协议(`NBSSN NetBIOS`)等

在**会话层**,有现在最常见的安全套接字层协议(`SSL`),传输层安全协议(`TLS`)等

在**传输层**,有传输适配接口层协议(`TALI`)

在**网络层**,有著名的互联网协议(`IP/IPv6`),路由协议(`RIP`)

在**数据链路层**,有地址解析协议(`ARP`),逆向地址解析协议(`RAR`)

在**物理层**,有`IEEE 802.2` , `Internetwork`


#### TCP/IP协议簇

我们说的`TCP/IP`通常意味着与TCP(传输控制协议)和IP(网际协议)有联系的东西,它是一个协议簇,并不仅仅代表一个协议,它包括其他的协议,应用软件,甚至网络媒介,比如UDP(⽤户数据报协议) ， ARP(地址解析协议) ，和 ICMP(控制报⽂协议),Telnet(远程登录)，FTP(文件传输协议)

>TCP/IP网络的基本构成

![](https://ws1.sinaimg.cn/large/40dfde6fgy1fqexsfgfapj20pu0fzwfi.jpg)

由图可见，以太网解决怎么传的问题、IP协议解决往哪里传的问题、UDP和TCP解决可靠性的问题。

如图的分层结构决定了计算机在互联网上相互通信的方式,数据通过这样的分层方式从上层传到底层,然后通过网线把数据传出去,IP是给在互联网中每一台联网的设备规定一个传输地址,TCP负责发现传输的问题,一有问题就发出信号,要求重新传输,直到所有数据完全正确的传输完毕

TCP/IP大致可以分为4层,他们又下至上分别为

**网络接口层**:它包含`以太网`,`WiFi`,`PPP`等协议

**网络互联层**:它包含`ARP`,`IP`,`ICMP`等协议

**数据传输层**:它包含`UDP`,`TCP`等协议

**应用层**:它包含`HTTP`,`FTP`,`DNS`,`SSH`等协议

### 以太网

以太网(Ethernet)指的是由Xerox公司创建并由Xerox、Intel和DEC公司联合开发的基带局域网规范，是当今现有局域网采用的最通用的通信协议标准。以太网络使用CSMA/CD（载波监听多路访问及冲突检测）技术，并以10M/S的速率运行在多种类型的电缆上。以太网与IEEE802.3系列标准相类似。

![](https://ws1.sinaimg.cn/large/40dfde6fgy1fqexvff1tej20s30dg3zl.jpg)

>CSMA/CD是一种争用型的介质访问控制协议。主要应用于现场总线以太网中，对于每一个站而言，一旦它检测到有冲突，它就放弃它当前的传送任务。换句话说，如果两个站都检测到信道是空闲的，并且同时开始传送数据，则它们几乎立刻就会检测到有冲突发生。它们不应该再继续传送它们的帧，因为这样只会产生垃圾而已；相反一旦检测到冲突之后，它们应该立即停止传送数据。快速地终止被损坏的帧可以节省时间和带宽。

#### 以太网地址

为了标识以太网上的每一台主机,我们需要给主机上的每一个网卡分配一个唯一的通讯地址,这个地址可以称为以太网地址,或Mac地址

Ethernet地址长度为48比特，共6个字节,前三个字节为IEEE分配给厂商的厂商代码,后3字节为忘了适配编号

#### 以太网帧格式

目前，有四种不同格式的以太网帧在使用，它们分别是：

1. Ethernet II即DIX 2.0：Xerox与DEC、Intel在1982年制定的以太网标准帧格式。Cisco名称为：ARPA
2. Ethernet 802.3 raw：Novell在1983年公布的专用以太网标准帧格式。Cisco名称为：Novell-Ether
3. Ethernet 802.3 SAP：IEEE在1985年公布的Ethernet 802.3的SAP版本以太网帧格式。Cisco名称为：SAP
4. Ethernet 802.3 SNAP：IEEE在1985年公布的Ethernet 802.3的SNAP版本以太网帧格式。Cisco名称为：SNAP

>在每种格式的以太网帧的开始处都有64比特(8字节)的前导字符,其中前7字节称为同步码(Preamble),内容是16进制数.最后1字节为帧其实标识符,他标识着以太网帧的开始,前导字符的作用是使接收节点进行同步并做好接收数据帧的准备。一个以太⽹网帧包含⽬目的地地址，源地址，属性域，和数据。
>以太⽹网帧离开⽹网卡进⼊入以太⽹网驱动程序,包能向上传递给 ARP(地址解析协议) 模块或到IP(⽹网间协议)模块。在以太⽹网帧的字段属性决定了了以太⽹网帧是否被传递给 ARP 或IP模块。

### IP协议

![](https://ws1.sinaimg.cn/large/40dfde6fgy1fqey60sd8aj20rj0ez41g.jpg)

1. IP协议是TCP/IP协议簇中的核心协议，也是TCP/IP的载体。所有的TCP，UDP，ICMP及IGMP数据都以IP数据报格式传输。
2. IP提供不可靠的，无连接的数据传送服务。
3. 不可靠指它不能保证IP数据报能成功到达目的地。IP仅提供最好的传输服务。当发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP消息给信源。任何要求的可靠性必须由上层来提供。
4. 无连接指IP并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先是A，然后是B）每个数据报都是独立的进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。 

如图所示的传输过程其实是这样的,首先我们发送一个IP包,但是我们此时并不知道目的的物理地址,这时我们就只能将IP包发给网关,通过ARP(地址解析协议)把IP地址翻译成物理地址,翻译通过查表进行,这个表叫做ARP地址转换表,它包含每一台计算机的信息,ARP地址转换协议是必须的因为IP地址和物理地址是互不不相⼲的,物理地址是由制造商基于以太⽹地址空间⽽而决定的，当物理硬件接⼝改变了，它的物理地址也随之改变了。如果顺利查到了物理地址,我们就将包发往这个地址,如果不能翻译时,一个携带物理地址的ARP包将被发送到网络下的每一台计算机,与此同时IP包排队等待,如果目标IP与响应计算机的IP地址相同,则会收到对应的响应,同时计算机的IP地址和物理地址会写到ARP地址转换表中更新,对于等候的IP包,通过查找更新后的ARP地址转换表翻译成物理地址,最后将以太网数据帧发送出去

>当ARP标不能翻译时,IP包就要等候,通过ARP请求/响应包得到对应关系,这样等待的IP包才会发送出去
>如果目的计算机不存在,则不会有ARP响应包,则发往这个地址的数据将会被丢弃


#### IP协议的功能

1. **寻址和路由**,根据对方的IP地址,寻找最佳路径传输信息
2. **传递服务**,事先不建立会话的传输服务,所以只能尽最大限度的去传输数据,可靠性由上层协议提供(**TCP**)
3. **数据包的分片和重组**,发送数据报过大时，就要对其数据报分片处理，每一个分片都会含有一个标识（IP地址 + 标识），到达目的地要对其所有的分片进行重新组装

#### IP数据包

![](https://img-blog.csdn.net/20170516161649348)
![](https://img-blog.csdn.net/20170516162438186)

一个IP数据包包含

1. 0100 = **Version** : 4（表示使用的 IPv4协议），对等层之间要使用同一种IP协议（IPv4协议）
2. 0101 = **Header Length** : 20Bytes(5) 首部长度(4 bit) ，可表示的最大数值为15个单位（1111），一个单位一个字节，最大为60字节
3. **服务类型**(8 bit) ，（Differentiated Services  Field）字段来区分服务，Delay = 1 延迟小，Throughput = 1吞吐量大，Reliability = 1 质量比较高，Cost = 1 最小代价！同一时刻只有一位是1
4. Total Length **总长度**(16 bit)：2^16 - 1 = 65535 字节，值首部和数据之和的长度，单位为字节，因此数据报的最大长度为65535字节（MTU最大传送单元）
5. **标识**（identification)(16 bit)，它是一个计数器，用来产生数据包的标识
6. **标志**（flag）:数据包在传输的过程中，标志字段MF（More Fregment），MF = 1表示后面还有分片，MF = 0 表示最后一个分片
7. **片偏移**：每个数据片不同时传输，标志着谋片在原分组中的相对偏移位置，以8字节为偏移单位
8. **生存时间**（Time To Live）(8bit) ，使用“跳数“作为TTL的单位。数据报每经历一个路由器时对应的TTL值就会减 1 ；防止数据报发送在路由器中出现环路，因为数据报在传送的过程中要占用一定的带宽（TTL值为零自动丢弃）
9. **协议**（8bit）字段指出此数据报所携带上层数据使用的TCP协议还是UDP协议，以便对等层接收到数据报交给上层相应的协议（TCP或者UDP协议）进行处理
10. **首部检验和**（Header  checksum   16bit）字段只校验数据报的首部，不包含数据部分；看IP数据报头部是否被破坏、被篡改和丢失等
11. **源地址**：数据向外发送，发送机器本身的IP地址，也成为逻辑地址
12. **目的地址**：数据具体要发送目标及其的IP地址

### TCP协议

**TCP**（Transmission Control Protocol 传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由IETF的RFC 793定义。TCP层是位于IP层之上，应用层之下的传输层。

TCP会话的每一端都包含一个32位（bit）的序列号，该序列号被用来跟踪该端发送的数据量。每一个包中都包含序列号，在接收端则通过确认号用来通知发送端数据成功接收。

#### TCP标志位

TCP在其协议头中使用大量的标志位或者说1位（bit）布尔域来控制连接状态，一个包中有可以设置多个标志位。
位码即TCP标志位，有6种标示：**SYN**(synchronous建立联机) **ACK**(acknowledgement 确认) **PSH**(push传送) **FIN**(finish结束) **RST**(reset重置) **URG**(urgent紧急) **Sequence number**(顺序号码) **Acknowledge number**(确认号码)


#### TCP连接建立的三次握手

所谓三次握手(Three-way Handshake)，是指建立一个TCP连接时，需要客户端和服务器总共发送3个包

1. 客户端发送SYN（SEQ=x）报文给服务器端，进入SYN_SEND状态
2. 服务器端收到SYN报文，回应一个SYN （SEQ=y）ACK(ACK=x+1）报文，进入SYN_RECV状态
3. 客户端收到服务器端的SYN报文，回应一个ACK(ACK=y+1）报文，进入Established状态

#### TCP连接断开的四次挥手

1. 某个应用进程首先调用close，称该端执行“主动关闭”（active close）。该端的TCP于是发送一个FIN分节给服务端，表示数据发送完毕
2. 服务端收到FIN,发回一个ACK报文,表示数据发送完毕
3. 服务端关闭与应用的连接,同时发送一个FIN给应用
4. 应用进行ACK报文确认









